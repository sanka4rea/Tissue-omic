---
title: "Supplementary materials, R code for downstream analysis"
author: QI LIN
mainfont: Arial
sansfont: Arial
monofont: Arial
header-includes: 
- \usepackage{titling}
- \posttitle{\end{center}}
- \usepackage{graphicx}
- \usepackage{float}

output:
   pdf_document:
      fig_caption: true
      number_sections: true
   fontsize: 12pt
---
\pagenumbering{arabic}
\tableofcontents
\newpage

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

\section{Preparation}
## Loading data and functions

This document presents R codes and data for reproducing our analysis result as described in the paper. To start, first load the R functions needed for analysis and plotting and load the data for the TCGA colorectal cancer samples, which is available as part of the paper supplement.

```{r}
library(ggplot2)
library(cowplot)
library(survival)
library(stringr)
load("./ProcessedDataAndClinical.rdata")
source("./getInfiltrateRatio.R")
source("./plotCorrelation.R")
source("./plot_KMCurve.R")
head(getInfiltrateRatio)
head(plotCorrelation)
head(plot_KMCurve)
```

## Clinical parameters 

Each row in this clinical file is a sample/patient from the TCGA cohort. Columns indicate: public patient ID (sample), gender, age, TNM stage, tumor location, relapse-free survival (rfs.event, rfs.delay), the status of microsatellite instability (mmr.status) ,consensus cluster subtype classification (cms), sample subsets (dataset), the fractions of stromal, immune, and tumor cells which were inferred from gene expression profiles by 'ESTIMATE' (StromalScore, ImmuneScore and TumorPurity). 

```{r}
head(Clinical_info)
```

\section{Whole-slide spatial organization features (SOFs)}

## Distributions of tissues

```{r,fig.height=6,fig.width=12}
distributionOfPatch<- sapply(1:length(CRC_locationMatrix),function(i){
  mat <- CRC_locationMatrix[[i]]
  tmp <- sapply(c(1:9), function(j){
    return(length(which(mat==j)))
  })
  return(tmp)
})
rownames(distributionOfPatch) <-c('ADI','BACK','DEB', 'LYM', 'MUC', 
                                  'MUS', 'NORM', 'STR', 'TUM')
colnames(distributionOfPatch) <- names(CRC_locationMatrix)
distributionOfPatch <- as.data.frame(t(distributionOfPatch))

Distribution <- distributionOfPatch[,1:9]/rowSums(distributionOfPatch[,1:9])
distriPlot <- data.frame(num=c(as.matrix(Distribution)))
distriPlot$class <- rep(c('ADI', 'BACK', 'DEB', 'LYM', 'MUC', 'MUS', 'NORM', 'STR', 'TUM'),
                        each=nrow(distributionOfPatch))
boxplot( num ~ class, distriPlot)
```

**Figure 2a. Distributions of whole-slide SOFs in the TCGA cohort.** 

## Generating whole-slide level SOFs

To evaluate the potential association between spatial organization features (SOFs) and the Consensus Molecular Subtypes (CMSs) of colorectal cancer, we calculated the relative abundance of image patches assigned to different tissue types in the whole-slide images as whole-slide tissue organization features (SOFs). More specifically, we first remove patches classified as background (BACK) and debris (DEB) for each whole-slide image in the TCGA cohort. The relative proportions of image patches classified to the other seven tissue types were subsequently calculated and compared between tumors belonging to different CMSs.

```{r}
WholeSlide_ratio <- distributionOfPatch[,-c(2,3)]/rowSums(distributionOfPatch[,-c(2,3)])
head(WholeSlide_ratio)
```

## Distributions and associations with CMSs of whole-slide SOFs

Each CMS has its characteristic tissue type that is significantly more abundant than the other CMSs

```{r}
all.equal(as.character(Clinical_info$sample),rownames(WholeSlide_ratio))
wilcox.test(WholeSlide_ratio$LYM[which(Clinical_info$cms=="CMS1")],
            WholeSlide_ratio$LYM[which(Clinical_info$cms!="CMS1")])
wilcox.test(WholeSlide_ratio$TUM[which(Clinical_info$cms=="CMS2")],
            WholeSlide_ratio$TUM[which(Clinical_info$cms!="CMS2")])
wilcox.test(WholeSlide_ratio$MUC[which(Clinical_info$cms=="CMS3")],
            WholeSlide_ratio$MUC[which(Clinical_info$cms!="CMS3")])
wilcox.test(WholeSlide_ratio$STR[which(Clinical_info$cms=="CMS4")],
            WholeSlide_ratio$STR[which(Clinical_info$cms!="CMS4")])

LYM_average <- sapply(c("CMS1","CMS2","CMS3","CMS4"), function(i){
  return(mean(WholeSlide_ratio$LYM[which(Clinical_info$cms==i)],na.rm=TRUE))
})
LYM_se <- sapply(c("CMS1","CMS2","CMS3","CMS4"), function(i){
  return(sd(WholeSlide_ratio$LYM[which(Clinical_info$cms==i)],na.rm=TRUE)/
           sqrt(length(which(Clinical_info$cms==i))))
})
LYM <- data.frame(Average=LYM_average,SE=LYM_se)*100
LYM$CMS <- c("CMS1","CMS2","CMS3","CMS4")
LYM <- ggplot(LYM,aes(x=CMS, y=Average,fill=CMS)) +  
  geom_bar(stat = "identity",position = "dodge",colour="black",width = 0.6)+ 
  scale_fill_manual(values=c("Dimgray","gray","gray","gray"))+
  geom_errorbar(aes(ymin=Average-SE, ymax=Average+SE), width=.2)+ 
  coord_cartesian(ylim=c(2, 8))+
  ggtitle("Whole-slide Lymphocyte Ratio")

TUM_average <- sapply(c("CMS1","CMS2","CMS3","CMS4"), function(i){
  return(mean(WholeSlide_ratio$TUM[which(Clinical_info$cms==i)],na.rm=TRUE))
})
TUM_se <- sapply(c("CMS1","CMS2","CMS3","CMS4"), function(i){
  return(sd(WholeSlide_ratio$TUM[which(Clinical_info$cms==i)],na.rm=TRUE)/
           sqrt(length(which(Clinical_info$cms==i))))
})
TUM <- data.frame(Average=TUM_average,SE=TUM_se)*100
TUM$CMS <- c("CMS1","CMS2","CMS3","CMS4")
TUM <- ggplot(TUM,aes(x=CMS, y=Average,fill=CMS)) + 
  geom_bar(stat = "identity",position = "dodge",colour="black",width = 0.6)+ 
  scale_fill_manual(values=c("gray","Dimgray","gray","gray"))+
  geom_errorbar(aes(ymin=Average-SE, ymax=Average+SE), width=.2)+
  coord_cartesian(ylim=c(20, 50))+
  ggtitle("Whole-slide Tumor Ratio")

MUC_average <- sapply(c("CMS1","CMS2","CMS3","CMS4"), function(i){
  return(mean(WholeSlide_ratio$MUC[which(Clinical_info$cms==i)],na.rm=TRUE))
})
MUC_se <- sapply(c("CMS1","CMS2","CMS3","CMS4"), function(i){
  return(sd(WholeSlide_ratio$MUC[which(Clinical_info$cms==i)],na.rm=TRUE)/
           sqrt(length(which(Clinical_info$cms==i))))
})
MUC <- data.frame(Average=MUC_average,SE=MUC_se)*100
MUC$CMS <- c("CMS1","CMS2","CMS3","CMS4")
MUC <- ggplot(MUC,aes(x=CMS, y=Average,fill=CMS)) +  
  geom_bar(stat = "identity",position = "dodge",colour="black",width = 0.6)+  
  scale_fill_manual(values=c("gray","gray","Dimgray","gray"))+
  geom_errorbar(aes(ymin=Average-SE, ymax=Average+SE), width=.2)+
  ggtitle("Whole-slide Mucus Ratio")

STR_average <- sapply(c("CMS1","CMS2","CMS3","CMS4"), function(i){
  return(mean(WholeSlide_ratio$STR[which(Clinical_info$cms==i)],na.rm=TRUE))
})
STR_se <- sapply(c("CMS1","CMS2","CMS3","CMS4"), function(i){
  return(sd(WholeSlide_ratio$STR[which(Clinical_info$cms==i)],na.rm=TRUE)/
           sqrt(length(which(Clinical_info$cms==i))))
})
STR <- data.frame(Average=STR_average,SE=STR_se)*100
STR$CMS <- c("CMS1","CMS2","CMS3","CMS4")
STR <- ggplot(STR,aes(x=CMS, y=Average,fill=CMS)) + 
  geom_bar(stat = "identity",position = "dodge",colour="black",width = 0.6)+ 
  scale_fill_manual(values=c("gray","gray","gray","Dimgray"))+
  geom_errorbar(aes(ymin=Average-SE, ymax=Average+SE), width=.2)+
  coord_cartesian(ylim=c(15, 32))+
  ggtitle("Whole-slide Stroma Ratio")

plot_grid(LYM,TUM,MUC,STR,ncol = 2,align = "hv")
```

**Figure 2c. Associations of whole-slide SPFs and molecular subtypes of colorectal cancer.**

<br />

Moreover, the whole-slide adipose, muscle, and normal ratios did not show significant differences between the four CMSs.

```{r, fig.height=4,fig.width=12}
par(mfrow = c(1, 3))
ADI_average <- sapply(c("CMS1","CMS2","CMS3","CMS4"), function(i){
  return(mean(WholeSlide_ratio$ADI[which(Clinical_info$cms==i)],na.rm=TRUE))
})
MUS_average <- sapply(c("CMS1","CMS2","CMS3","CMS4"), function(i){
  return(mean(WholeSlide_ratio$MUS[which(Clinical_info$cms==i)],na.rm=TRUE))
})
NORM_average <- sapply(c("CMS1","CMS2","CMS3","CMS4"), function(i){
  return(mean(WholeSlide_ratio$NORM[which(Clinical_info$cms==i)],na.rm=TRUE))
})
barplot(ADI_average,names.arg =c("CMS1","CMS2","CMS3","CMS4"),
        col = rep("gray",4), beside=TRUE,main = "Whole-slide Adipose Ratio")
barplot(MUS_average,names.arg =c("CMS1","CMS2","CMS3","CMS4"),
        col = rep("gray",4), beside=TRUE,main = "Whole-slide Muscle Ratio")
barplot(NORM_average,names.arg =c("CMS1","CMS2","CMS3","CMS4"), 
        col = rep("gray",4), beside=TRUE,main = "Whole-slide Normal Ratio")
```

**Supplementary Figure 2a. Distribution of whole-slide adipose, muscle, and normal ratios.**

<br />

## Distributions and associations with CMSs of ESTIMATE scores

The fractions of stromal, immune, and tumor cells can also be inferred from bulk tumor gene expression profiles using their corresponding gene expression signatures by ESTIMATE.


```{r, fig.height=4,fig.width=12}
par(mfrow = c(1, 3))
ImmuneScore <- sapply(c("CMS1","CMS2","CMS3","CMS4"), function(i){
  return(mean(Clinical_info$ImmuneScore[which(Clinical_info$cms==i)],na.rm=TRUE))
})
StromalScore <- sapply(c("CMS1","CMS2","CMS3","CMS4"), function(i){
  return(mean(Clinical_info$StromalScore[which(Clinical_info$cms==i)],na.rm=TRUE))
})
TumorPurity <- sapply(c("CMS1","CMS2","CMS3","CMS4"), function(i){
  return(mean(Clinical_info$TumorPurity[which(Clinical_info$cms==i)],na.rm=TRUE))
})

barplot(ImmuneScore,names.arg =c("CMS1","CMS2","CMS3","CMS4"),
        col = rep("gray",4), beside=TRUE,main = "Immune Score",ylim = c(0, 1200))
barplot(StromalScore,names.arg =c("CMS1","CMS2","CMS3","CMS4"),
        col = rep("gray",4), beside=TRUE,main = "Stromal Score",ylim = c(-1500, 150))
barplot(TumorPurity,names.arg =c("CMS1","CMS2","CMS3","CMS4"), 
        col = rep("gray",4), beside=TRUE,main = "Tumor Purity",ylim = c(0.595, 0.93))
```

**Supplementary Figure 2b. Distribution of immune scores, stromal scores and tumor purity levels.**

## Correlation of Whole-slide SOFs and ESTIMATE scores

The whole-slide spatial organization features (SOFs) and ESTIMATE scores are significantly correlated


```{r, fig.height=4,fig.width=12}
head(plotCorrelation)
LYM_cor <- data.frame(a=as.numeric(WholeSlide_ratio$LYM), 
                      b=as.numeric(Clinical_info$ImmuneScore))
LYM_cor_plot <- plotCorrelation(x=LYM_cor$a, y=LYM_cor$b,groups = NULL,
                                legend.pos = "none",maintitle="LYM-Immune Score")

STR_cor <- data.frame(a=as.numeric(WholeSlide_ratio$STR), 
                      b=as.numeric(Clinical_info$StromalScore))
STR_cor_plot <- plotCorrelation(x=STR_cor$a, y=STR_cor$b,groups = NULL,
                                legend.pos = "none",maintitle="STR-Stromal Score")

TUM_cor <- data.frame(a=as.numeric(WholeSlide_ratio$TUM),
                      b=as.numeric(Clinical_info$TumorPurity))
TUM_cor_plot <-plotCorrelation(x=TUM_cor$a, y=TUM_cor$b,groups = NULL,
                               legend.pos = "none",maintitle="TUM-Tumor Purity")

plot_grid(LYM_cor_plot,STR_cor_plot,TUM_cor_plot,ncol = 3,align = "hv")
```

**Supplementary Figure 3. Correlation of Whole-slide SOFs and ESTIMATE scores.**

<br />

\section{Infiltrating spatial organization features}

## Generating infiltrating SOFs

Whole-slide H&E stained images often contain large areas of tissues without tumor cells, which may not be functionally relevant and associated with clinical outcomes. To calculate SOFs in the proximity of tumor tissues, a 6 × 6 tissue patches window (1536 × 1536 pixels) with a 50% overlap (768-pixel step size) was used to scan the whole-slide image to identify regions of interests (ROIs).


```{r}
InfiltrateRatio <- getInfiltrateRatio(windows=6,overlap=0.5,
                                      locationMatrix=CRC_locationMatrix)
InfiltrateRatio[,1:10]
all.equal(rownames(Clinical_info),colnames(InfiltrateRatio))
Clinical_info$ILR <- InfiltrateRatio['LYM',] 
Clinical_info$ISR <- InfiltrateRatio['STR',]
```

## Univariate cox regression analyses

We found the TNM stage, infiltrating lymphocyte ratio (ILR), and infiltrating stroma ratio (ISR) were significantly associated with relapse-free survival. However, the stromal and immune scores calculated by ESTIMATE did not show significant associations with RFS.


```{r}
index <- which(is.na(Clinical_info$rfs.delay)==TRUE | 
                 is.na(Clinical_info$rfs.event)==TRUE)
CoxCli <- Clinical_info[-index,]
factor_name <- c("sex", "age", "tumor.location","tnm.stage", 
                 "mmr.status","StromalScore","ImmuneScore","TumorPurity","ILR","ISR" )
clin_factors <- CoxCli[, factor_name]

dfs_time <- CoxCli$rfs.delay
dfs_event <- CoxCli$rfs.event
res <- Surv(dfs_time,dfs_event)

univ_formulas <- sapply(factor_name,function(x) as.formula(paste('res ~', x)))
univ_models <- lapply(univ_formulas, function(x){summary(coxph(x, data=CoxCli) ) })
univ_results <- sapply(1:length(univ_models),
                       function(i){ 
                         x <- univ_models[[i]]
                         p <- x$logtest[3]
                         HR <- x$conf.int[1,c(1,3,4)]
                         p <- as.numeric(p)
                         aa <- c(HR,p)
                         return(aa)
                       })
colnames(univ_results) <- factor_name
rownames(univ_results) <- c("HR","L95","H95","logtest_P")
univ_results <- t(univ_results)
univ_results
```

**Table 2. Univariate analyses of spatial organization features, ESTIMATE scores, clinical, and pathologic factors in the TCGA cohort.**

## Survival analyses of infiltrating SOFs

```{r, fig.height=5,fig.width=5, message=FALSE, warning=FALSE}
ILR <- CoxCli$ILR
ILR_label_F <- function(score,cut){
  tmp <- score >=cut
  tmp <- str_replace_all(tmp,"TRUE","LH")
  tmp <- str_replace_all(tmp,"FALSE","LL")
  return(tmp)
}
ILR_label <- as.factor(as.character(ILR_label_F(ILR,summary(ILR)[3])))  
  
ISR_label_H <- function(score,cut){
  tmp <- score >=cut
  tmp <- str_replace_all(tmp,"TRUE","LHSH")
  tmp <- str_replace_all(tmp,"FALSE","LHSL")
  return(tmp)
}
ISR_label_L <- function(score,cut){
  tmp <- score >=cut
  tmp <- str_replace_all(tmp,"TRUE","LLSH")
  tmp <- str_replace_all(tmp,"FALSE","LLSL")
  return(tmp)
}

score1LH <- CoxCli$ISR[which(ILR_label=="LH")]
labelLH <- as.factor(as.character(ISR_label_H(score1LH,summary(score1LH)[3]))) 
score1LL <- CoxCli$ISR[which(ILR_label=="LL")]
labelLL <- as.factor(as.character(ISR_label_L(score1LL,summary(score1LL)[3]))) 
info <- rbind(CoxCli[which(ILR_label=="LH"),],CoxCli[which(ILR_label=="LL"),])
info$pa_labels <- c(as.character(labelLH) ,as.character(labelLL) ) 
labels <- info$pa_labels
labels <- factor(labels,levels=c("LLSL","LHSL","LLSH","LHSH"))
legend.labs <- as.vector(na.omit(unique(labels)))
input <- as.data.frame( cbind(info$rfs.delay,info$rfs.event)) 
plot_KMCurve(input,labels,ylab="Relapse Free Survival", 
             color = c("#056DB7", "#F89F23","grey","red"), 
             legend.pos = c(0.8,0.8),xlab="Months")
```

**Figure 3. Infiltrating lymphocyte and stroma ratios are significant prognosticators of CRC in TCGA CRC cohort.**

<br>

\section{Session Info}

This document was prepared using R package knitr. Funciton knit2pdf("sweave.rnw") was used to compile the sweave file and generate the pdf file.


```{r}
sessionInfo()
```
